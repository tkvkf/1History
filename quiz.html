<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>퀴즈</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="some-box">
        <br>
        <div id="question"></div>
        <br>
        <input type="text" id="answer" placeholder="연도를 입력하세요" autocomplete="off">
        <div id="result"></div>
        <button id="submitBtn" onclick="checkAnswer()">제출</button>
        <button id="nextBtn" onclick="nextQuestion()" style="display:none;">다음 문제</button>
        <button id="endBtn" onclick="endQuiz()" style="display:none;">끝내기</button>
    </div>
    <script>
        let quizData = [];
        let current = 0;
        let answered = false;
        let filtered = [];
        let score = 0;

        fetch("data.json")
            .then(response => response.json())
            .then(data => {
                quizData = data;
                startQuiz();
            })
            .catch(error => {
                console.error('퀴즈 데이터 로드 실패:', error);
                document.getElementById('question').textContent = "퀴즈 데이터를 불러오는 데 실패했습니다.";
            });

        function getQueryParams() {
            const params = {};
            const searchParams = new URLSearchParams(location.search);
            for (const [key, value] of searchParams.entries()) {
                params[key] = value;
            }
            return params;
        }

        function startQuiz() {
            const params = getQueryParams();
            const tag = params.tag || "all";
            const selectedTags = tag === "all" ? ["all"] : tag.split(",");
            const startYear = parseFloat(params.startYear, 10) || 1900;
            const endYear = (parseFloat(params.endYear, 10) || 2020) + 0.99;
            const mode = params.mode === "true";

            filtered = quizData.filter(q => {
                const year = parseFloat(q.year);
                const tagMatch = selectedTags.includes("all") || selectedTags.includes(String(q.tags));
                return tagMatch && year >= startYear && year <= endYear;
            });

            function parseYearMonth(str) {
                const [y, m] = String(str).split(".");
                return {
                    year: parseInt(y, 10),
                    month: m !== undefined ? parseInt(m, 10) : 0
                };
            }

            if (mode) {
                filtered = filtered.sort(() => Math.random() - 0.5);
            } else {
                filtered.sort((a, b) => {
                    const ay = parseYearMonth(a.year);
                    const by = parseYearMonth(b.year);
                    if (ay.year !== by.year) return ay.year - by.year;
                    return ay.month - by.month;
                });
            }

            showQuestion();

            document.getElementById('answer').addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    if (!answered) {
                        checkAnswer();
                    } else {
                        if (current < filtered.length - 1) {
                            nextQuestion();
                        } else {
                            endQuiz();
                        }
                    }
                }
            });
        }

        function showQuestion() {
            answered = false;
            document.getElementById('result').textContent = '';
            document.getElementById('answer').value = '';
            if (filtered.length === 0) {
                document.getElementById('question').textContent = "해당 조건의 문제가 없습니다.";
                document.getElementById('submitBtn').style.display = "none";
                document.getElementById('nextBtn').style.display = "none";
                document.getElementById('endBtn').style.display = "inline-block";
                return;
            }
            document.getElementById('question').textContent = `${current + 1}. "${filtered[current].event}"는 몇 년도에 일어났나요? ${filtered[current].year}`;
            document.getElementById('submitBtn').style.display = "inline-block";
            document.getElementById('nextBtn').style.display = "none";
            document.getElementById('endBtn').style.display = "none";
        }

        function checkAnswer() {
            if (answered) return;
            const userAnswer = document.getElementById('answer').value.trim();
            if (userAnswer === filtered[current].year) {
                document.getElementById('result').innerHTML = `정답입니다!<br>${current + 1} / ${filtered.length}`; score++;
            } else {
                document.getElementById('result').innerHTML = `오답입니다. 정답: ${filtered[current].year}<br>${current + 1} / ${filtered.length}`;
            }
            answered = true;
            document.getElementById('submitBtn').style.display = "none";
            if (current < filtered.length - 1) {
                document.getElementById('nextBtn').style.display = "inline-block";
            } else {
                document.getElementById('endBtn').style.display = "inline-block";
            }
        }

        function nextQuestion() {
            if (current < filtered.length - 1) {
                current++;
                showQuestion();
            }
        }

        function endQuiz() {
            window.location.href = `end.html?score=${encodeURIComponent(score)}&total=${encodeURIComponent(filtered.length)}`;
        }
    </script>
</body>

</html>